{% extends "layout.html" %}
{% block content %}
<div class="container py-4">

  <!-- =========================================================
       HEADER
  ========================================================== -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="display-5 mb-1">Dashboard</h1>
      <p class="text-muted mb-0">Welcome back, {{ current_user.name or current_user.username }}!</p>
    </div>
    <div class="d-none d-md-block">
      {% for f in features %}
        <span class="badge bg-secondary me-1 text-capitalize">{{ f.replace('_',' ') }}</span>
      {% endfor %}
    </div>
  </div>

  <!-- =========================================================
       TOP STATS CARDS
  ========================================================== -->
    <!-- =========================================================
       TOP STATS CARDS (clickable buttons -> go to /tasks with status)
  ========================================================== -->
  <div class="row g-3 mb-4">
  <div class="col-12 col-md-3">
    <button type="button"
            class="card h-100 w-100 text-center btn summary-card-btn {% if (request.args.get('status') or 'all') == 'all' %}active-summary{% endif %}"
            data-href="{{ url_for('main.all_tasks', status='all') }}"
            data-status="all"
            aria-label="Show all tasks">
      <div class="card-body">
        <div class="h1 mb-0">{{ task_counts.total }}</div>
        <div class="text-muted">Total Tasks</div>
      </div>
    </button>
  </div>

  <div class="col-12 col-md-3">
    <button type="button"
            class="card h-100 w-100 text-center btn summary-card-btn {% if (request.args.get('status') or '') == 'pending' %}active-summary{% endif %}"
            data-href="{{ url_for('main.all_tasks', status='pending') }}"
            data-status="pending"
            aria-label="Show pending tasks">
      <div class="card-body">
        <div class="h1 mb-0">{{ task_counts.pending }}</div>
        <div class="text-muted">Pending</div>
      </div>
    </button>
  </div>

  <div class="col-12 col-md-3">
    <button type="button"
            class="card h-100 w-100 text-center btn summary-card-btn {% if (request.args.get('status') or '') == 'completed' %}active-summary{% endif %}"
            data-href="{{ url_for('main.all_tasks', status='completed') }}"
            data-status="completed"
            aria-label="Show completed tasks">
      <div class="card-body">
        <div class="h1 mb-0">{{ task_counts.completed }}</div>
        <div class="text-muted">Completed</div>
      </div>
    </button>
  </div>

  <div class="col-12 col-md-3">
    <button type="button"
            class="card h-100 w-100 text-center btn summary-card-btn {% if (request.args.get('status') or '') == 'overdue' %}active-summary{% endif %}"
            data-href="{{ url_for('main.all_tasks', status='overdue') }}"
            data-status="overdue"
            aria-label="Show overdue tasks">
      <div class="card-body">
        <div class="h1 mb-0">{{ task_counts.overdue }}</div>
        <div class="text-muted">Overdue</div>
      </div>
    </button>
  </div>
</div>
</div>






  <!-- =========================================================
       ACTION BAR
  ========================================================== -->
  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
      <i class="bi bi-plus-lg"></i> New Task
    </button>

    <a href="{{ url_for('main.all_tasks') }}" class="btn btn-outline-secondary">
      <i class="bi bi-list-ul"></i> All Tasks
    </a>

    <a href="{{ url_for('main.onboarding') }}" class="btn btn-outline-info">
      <i class="bi bi-gear"></i> Preferences
    </a>

    {% if 'graphs' in features or current_user.feature_progress_graphs %}
    <a href="{{ url_for('main.dashboard_graphs') }}" class="btn btn-outline-primary ms-2">
      <i class="bi bi-bar-chart"></i> Graphs
    </a>
    {% endif %}



    {% if 'task_export' in features or current_user.feature_task_export %}
    <button id="exportTasksBtn" class="btn btn-outline-dark">
      <i class="bi bi-box-arrow-up-right"></i> Export
    </button>
    {% endif %}

    <div class="ms-auto d-flex flex-wrap gap-2">
      <form class="d-flex" method="get" action="{{ url_for('main.dashboard_customized') }}">
        <input name="search" value="{{ search_term or '' }}" class="form-control" placeholder="Search tasks‚Ä¶">
        <button class="btn btn-outline-secondary ms-2">Search</button>
      </form>
    </div>

  </div>

  <div class="row">
    <!-- =======================================================
         LEFT: TASK TABLE + RECENT ACTIVITY
    ======================================================== -->
    <div class="col-12 col-lg-8">
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>Tasks</strong>
          <div class="d-flex align-items-center gap-2">
            <select id="clientFilterStatus" class="form-select form-select-sm" style="width:auto">
              <option value="">All</option>
              <option value="late" {% if filter_status == 'late' %}selected{% endif %}>Late</option>
              <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending</option>
              <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
            <select id="clientFilterPriority" class="form-select form-select-sm" style="width:auto">
              <option value="">Any Priority</option>
              <option value="1" {% if filter_priority|string == '1' %}selected{% endif %}>High</option>
              <option value="2" {% if filter_priority|string == '2' %}selected{% endif %}>Medium</option>
              <option value="3" {% if filter_priority|string == '3' %}selected{% endif %}>Low</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th style="min-width:220px">Task</th>
                  <th>Due</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for task in paginated_tasks.items %}
                <tr>
                  <td>{{ task.title }}</td>
                  <td>{{ task.due_date.strftime('%Y-%m-%d %H:%M') if task.due_date else 'No due date' }}</td>
                  <td>
                    {% if task.priority == 1 %}
                      <span class="badge bg-danger">High</span>
                    {% elif task.priority == 2 %}
                      <span class="badge bg-warning text-dark">Medium</span>
                    {% elif task.priority == 3 %}
                      <span class="badge bg-secondary">Low</span>
                    {% else %}
                      <span class="badge bg-secondary">‚Äî</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if task.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                    {% elif task.status == 'in progress' %}
                        <span class="badge bg-info text-dark">In Progress</span>
                    {% elif task.status == 'not started' %}
                        <span class="badge bg-secondary">Not Started</span>
                    {% elif task.status == 'overdue' %}
                        <span class="badge bg-danger">Overdue</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ task.status }}</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if 'task_timer' in features or current_user.feature_task_timer %}
                    <button class="btn btn-sm btn-outline-success scroll-to-timer" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}">
                      ‚è± Start
                    </button>
                    {% endif %}

                    <a href="{{ url_for('main.edit_task', id=task.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è Edit</a>
                    <button class="btn btn-sm btn-danger delete-task-btn" data-task-id="{{ task.id }}" data-bs-toggle="modal" data-bs-target="#deleteTaskModal">üóëÔ∏è Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <!-- DELETE TASK MODAL -->
        <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTaskModalLabel">Delete Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTaskBtn">Delete</button>
            </div>
            </div>
        </div>
        </div>

      <!-- =======================================================
           RECENT ACTIVITY
      ======================================================== -->
      <div class="card mb-4">
        <div class="card-header"><strong>Recent Activity</strong></div>
        <ul class="list-group list-group-flush">
          {% for t in recent_tasks %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ t.title }}</strong>
              <div class="small text-muted">Due: {% if t.due_date %}{{ t.due_date.strftime('%b %d, %Y') }}{% else %}‚Äî{% endif %}</div>
            </div>
            <div class="text-end small">
              {% if t.completed %}
                <span class="text-success">Completed</span>
              {% else %}
                <span class="text-muted">Pending</span>
              {% endif %}
            </div>
          </li>
          {% else %}
          <li class="list-group-item text-muted">No recent activity</li>
          {% endfor %}
        </ul>
      </div>

      <!-- =======================================================
           INLINE FOCUS TIMER
      ======================================================== -->
      {% if 'task_timer' in features or current_user.feature_task_timer %}
      <div id="inlineTimerOverlay" class="d-none">
        <div id="inlineTimerModal" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" 
            style="background: rgba(0,0,0,0.7); z-index:1050;">
            <div class="card p-4 text-center" style="width: 400px; max-width:90%; border-radius: 1rem;">
            <h3 id="inlineTimerTitle">Task Timer</h3>
            <div class="my-4" style="font-size:4rem; font-weight:bold;" id="countdownDisplay">00:00</div>
            <form id="inlineTimerForm" class="mb-3">
                <input type="hidden" id="inlineTaskId">
                <div class="mb-3">
                <label for="inlineTimerMinutes" class="form-label">Minutes:</label>
                <input type="number" id="inlineTimerMinutes" class="form-control" placeholder="Enter minutes" min="1">
                </div>
                <button type="submit" class="btn btn-success w-100 mb-2">Start</button>
                <button type="button" class="btn btn-danger w-100" id="closeInlineTimer">Close</button>
            </form>
            </div>
        </div>
      </div>
      {% endif %}

    </div> <!-- End LEFT Column -->

    <!-- =======================================================
         RIGHT: FEATURE CARDS
    ======================================================== -->
    <div class="col-12 col-lg-4">

      <!-- =======================================================
           ADD TASK CARD (INLINE)
      ======================================================== -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title mb-3">Add Task</h5>
          <form method="post" action="{{ url_for('main.dashboard_customized') }}">
            {{ task_form.hidden_tag() }}
            <div class="mb-2">
              {{ task_form.title(class="form-control", placeholder="Task title") }}
              {% if task_form.title.errors %}
                <div class="text-danger small">{{ task_form.title.errors[0] }}</div>
              {% endif %}
            </div>
            <div class="mb-2">
              {{ task_form.description(class="form-control", placeholder="Description (optional)", rows="3") }}
            </div>
            <div class="mb-2">
              {{ task_form.due_date(class="form-control") }}
            </div>
            <div class="mb-2 d-flex gap-2 align-items-center">
              {{ task_form.priority(class="form-select w-50") }}
              <div class="form-check">
                {{ task_form.reminder_set(class="form-check-input", id="remSetInline") }}
                <label class="form-check-label small" for="remSetInline">Reminder</label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-2">
              <i class="bi bi-plus-lg"></i> Add Task
            </button>
          </form>
        </div>
      </div>

      <!-- =======================================================
           GAMIFICATION CARD
      ======================================================== -->
      {% if 'gamification' in features or current_user.feature_gamification %}
      <div class="card mb-3">
        <div class="card-header"><strong>Gamification</strong></div>
        <div class="card-body text-center">
          <div class="h2">{{ current_user.points|default(0) }}</div>
          <small class="text-muted">Points</small>
          <div class="mt-2">
            <div class="progress">
              <div class="progress-bar" role="progressbar"
                   data-points="{{ current_user.points_percentage|default(0)|int }}"
                   aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
          <small class="text-muted">Level {{ current_user.level|default(1) }}</small>
        </div>
      </div>
      {% endif %}

      <!-- =======================================================
           DAILY TIPS CARD
      ======================================================== -->
      {% if 'tips' in features or current_user.feature_tips %}
      <div class="card mb-3">
        <div class="card-header"><strong>Daily Tips</strong></div>
        <div class="card-body">
          {% for tip in daily_tips %}
            <p class="mb-2"><i class="bi bi-lightbulb-fill text-warning"></i> {{ tip }}</p>
          {% else %}
            <p class="text-muted mb-0">No tips for today.</p>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- =======================================================
           REMINDERS CARD
      ======================================================== -->
      {% if 'reminders' in features or current_user.feature_auto_reminders %}
      <div class="card mb-3">
        <div class="card-header"><strong>Upcoming Reminders</strong></div>
        <ul class="list-group list-group-flush">
          {% for r in reminders %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ r.task.title }}</span>
              <small class="text-muted">{{ r.remind_at.strftime('%b %d %H:%M') }}</small>
            </li>
          {% else %}
            <li class="list-group-item text-muted">No upcoming reminders</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    </div>
  </div>

</div>

<!-- =========================================================
     NEW TASK MODAL
========================================================== -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('main.dashboard_customized') }}">
        {{ task_form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="newTaskModalLabel">New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ task_form.title(class="form-control", placeholder="Task Title") }}
            {% if task_form.title.errors %}
              <div class="text-danger small">{{ task_form.title.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ task_form.description(class="form-control", placeholder="Description", rows="3") }}
          </div>
          <div class="mb-3">
            {{ task_form.due_date(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ task_form.priority(class="form-select") }}
          </div>
          <div class="form-check mb-3">
            {{ task_form.reminder_set(class="form-check-input", id="remSetModal") }}
            <label class="form-check-label" for="remSetModal">Set Reminder</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =========================================================
     CUSTOM SCRIPT SECTION
========================================================== -->
{% block scripts %}
<script>

document.addEventListener('DOMContentLoaded', function () {

  // --------------------------
  // Feature set (safe Jinja -> JS)
  // Use default([]) so the template always emits a valid JSON array even if `features` is undefined.
  // --------------------------
  const enabledFeatures = new Set(JSON.parse('{{ (features|default([]))|tojson|safe }}'));
  function hasFeature(name) { return enabledFeatures.has(name); }
  window.dashboardFeatures = Array.from(enabledFeatures); // for debugging in browser console

  // --------------------------
  // CSRF helper (safe fallback)
  // --------------------------
  function getCsrfToken() {
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    if (csrfInput && csrfInput.value) return csrfInput.value;
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.getAttribute('content');
    // sometimes Flask-WTF exposes csrf_token() as a global; avoid using template function in JS
    return null;
  }
  const CSRF_TOKEN = getCsrfToken();

  // --------------------------
  // Generic POST JSON helper
  // --------------------------
  function postJSON(url, payload) {
    const headers = { 'Content-Type': 'application/json' };
    if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
    return fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify(payload)
    });
  }

  // --------------------------
  // EXPORT TASKS
  // --------------------------
  (function setupExport() {
    const btn = document.getElementById('exportTasksBtn');
    if (!btn) return;
    if (!hasFeature('task_export')) {
      btn.classList.add('d-none');
      return;
    }
    btn.addEventListener('click', function () {
      fetch("{{ url_for('main.export_tasks') }}")
        .then(r => {
          if (!r.ok) throw new Error('Export failed');
          return r.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'tasks.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        })
        .catch(err => console.error('Export error:', err));
    });
  })();

  // --------------------------
  // INLINE TIMER / START / FINISH
  // --------------------------
  (function setupInlineTimer() {
    // If feature disabled, hide start buttons and ensure overlay hidden
    if (!hasFeature('task_timer')) {
      document.querySelectorAll('.scroll-to-timer').forEach(b => b.classList.add('d-none'));
      const overlayEl = document.getElementById('inlineTimerOverlay');
      if (overlayEl) overlayEl.classList.add('d-none');
      return;
    }

    const overlay = document.getElementById('inlineTimerOverlay');
    const countdownDisplay = document.getElementById('countdownDisplay');
    const inlineForm = document.getElementById('inlineTimerForm');
    const minutesInput = document.getElementById('inlineTimerMinutes');
    const taskIdInput = document.getElementById('inlineTaskId');
    const titleElem = document.getElementById('inlineTimerTitle');

    // create "Task finished" button inside overlay if not present
    let finishBtn = document.getElementById('finishTaskBtn');
    if (!finishBtn && overlay) {
      finishBtn = document.createElement('button');
      finishBtn.type = 'button';
      finishBtn.id = 'finishTaskBtn';
      finishBtn.className = 'btn btn-outline-primary w-100 mt-2';
      finishBtn.textContent = 'Task finished';
      const form = overlay.querySelector('#inlineTimerForm');
      if (form) form.appendChild(finishBtn);
    }

    let countdownInterval = null;
    let secondsRemaining = 0;

    // Update the status badge in the task row for immediate UI feedback
    function updateStatusBadgeOnRow(taskId, status) {
      if (!taskId) return;
      const triggerBtn = document.querySelector(`button.scroll-to-timer[data-task-id="${taskId}"]`);
      if (!triggerBtn) return;
      const tr = triggerBtn.closest('tr');
      if (!tr) return;
      const statusCell = tr.querySelector('td:nth-child(4)');
      if (!statusCell) return;

      let badgeClasses = 'badge bg-secondary';
      let badgeText = status;
      if (status === 'completed') { badgeClasses = 'badge bg-success'; badgeText = 'Completed'; }
      else if (status === 'in progress') { badgeClasses = 'badge bg-info text-dark'; badgeText = 'In Progress'; }
      else if (status === 'not started') { badgeClasses = 'badge bg-secondary'; badgeText = 'Not Started'; }
      else if (status === 'overdue') { badgeClasses = 'badge bg-danger'; badgeText = 'Overdue'; }
      else { badgeClasses = 'badge bg-secondary'; badgeText = status; }

      statusCell.innerHTML = `<span class="${badgeClasses}">${badgeText}</span>`;
    }

    // Server update for status; returns a promise
    function updateTaskStatus(taskId, newStatus) {
      if (!taskId) return Promise.reject('missing taskId');
      const urlTemplate = "{{ url_for('main.update_status', id=0) }}";
      const url = urlTemplate.replace('0', taskId);
      return postJSON(url, { status: newStatus })
        .then(resp => {
          if (!resp.ok) throw new Error('update failed');
          updateStatusBadgeOnRow(taskId, newStatus);
          return resp;
        })
        .catch(err => {
          console.error('Status update failed', err);
          throw err;
        });
    }

    // open overlay for a task and set in-progress on server (best-effort)
    function openOverlayFor(taskId, taskTitle) {
      if (!overlay) return;
      taskIdInput.value = taskId;
      titleElem.textContent = taskTitle || 'Task Timer';
      countdownDisplay.textContent = '00:00';
      // reset any existing timer
      clearInterval(countdownInterval);
      countdownInterval = null;
      secondsRemaining = 0;
      overlay.classList.remove('d-none');

      // set 'in progress' immediately (best-effort update)
      updateTaskStatus(taskId, 'in progress').catch(() => {
        // ignored; UI already shows overlay
      });
    }

    // hook start buttons
    document.querySelectorAll('.scroll-to-timer').forEach(btn => {
      btn.addEventListener('click', function () {
        const tId = this.dataset.taskId;
        const tTitle = this.dataset.taskTitle;
        openOverlayFor(tId, tTitle);
      });
    });

    // finish button (user marks task finished early)
    if (finishBtn) {
      finishBtn.addEventListener('click', function () {
        const tid = taskIdInput.value;
        if (!tid) return;
        clearInterval(countdownInterval);
        countdownInterval = null;
        secondsRemaining = 0;
        updateTaskStatus(tid, 'completed')
          .finally(() => {
            if (overlay) overlay.classList.add('d-none');
          });
      });
    }

    // close overlay button
    const closeInline = document.getElementById('closeInlineTimer');
    if (closeInline) {
      closeInline.addEventListener('click', function () {
        clearInterval(countdownInterval);
        countdownInterval = null;
        if (overlay) overlay.classList.add('d-none');
      });
    }

    // modal that asks Yes/No when timer ends
    function showTimerEndModal(taskId) {
      const MID = 'inlineTimerEndModal';
      let modalEl = document.getElementById(MID);
      if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.className = 'modal fade';
        modalEl.id = MID;
        modalEl.tabIndex = -1;
        modalEl.innerHTML = `
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning">
              <div class="modal-header bg-warning">
                <h5 class="modal-title">Time is up</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p class="mb-0">Did you finish the task?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="${MID}-no">No</button>
                <button type="button" class="btn btn-warning" id="${MID}-yes">Yes</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(modalEl);
      }

      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();

      const yesBtn = modalEl.querySelector(`#${MID}-yes`);
      const noBtn = modalEl.querySelector(`#${MID}-no`);

      function doYes() {
        updateTaskStatus(taskId, 'completed').finally(() => bsModal.hide());
        cleanup();
      }
      function doNo() {
        updateTaskStatus(taskId, 'in progress').finally(() => bsModal.hide());
        cleanup();
      }
      function cleanup() {
        if (yesBtn) yesBtn.removeEventListener('click', doYes);
        if (noBtn) noBtn.removeEventListener('click', doNo);
      }

      if (yesBtn) yesBtn.addEventListener('click', doYes);
      if (noBtn) noBtn.addEventListener('click', doNo);
    }

    // start countdown when inline form is submitted
    if (inlineForm) {
      inlineForm.addEventListener('submit', function (e) {
        e.preventDefault();
        let minutes = parseInt(minutesInput.value || '1', 10);
        if (!minutes || minutes <= 0) minutes = 1;
        secondsRemaining = minutes * 60;

        clearInterval(countdownInterval);
        countdownInterval = setInterval(() => {
          const m = Math.floor(secondsRemaining / 60);
          const s = secondsRemaining % 60;
          countdownDisplay.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;

          if (secondsRemaining <= 0) {
            clearInterval(countdownInterval);
            countdownInterval = null;
            const tid = taskIdInput.value;
            if (overlay) overlay.classList.add('d-none');
            // show yes/no modal
            showTimerEndModal(tid);
          }
          secondsRemaining--;
        }, 1000);
      });
    }
  })();

  // --------------------------
  // DELETE TASK modal (red popup)
  // --------------------------
  (function setupDeleteModal() {
    const deleteModalEl = document.getElementById('deleteTaskModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteTaskBtn');
    let deleteTaskId = null;

    // capture which task id to delete when delete button clicked
    document.querySelectorAll('.delete-task-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        deleteTaskId = this.dataset.taskId;
      });
    });

    if (!deleteModalEl || !confirmDeleteBtn) return;

    confirmDeleteBtn.addEventListener('click', function () {
      if (!deleteTaskId) {
        // try fallback: find delete button currently triggering the modal
        const possible = document.querySelector('.delete-task-btn[data-bs-toggle="modal"][data-bs-target="#deleteTaskModal"]');
        if (possible) deleteTaskId = possible.dataset.taskId;
      }
      if (!deleteTaskId) return;

      const deleteUrl = "{{ url_for('main.delete_task', id=0) }}".replace('0', deleteTaskId);
      // prefer POST JSON, but fallback to plain fetch if necessary
      postJSON(deleteUrl, {})
        .then(resp => {
          if (!resp.ok) {
            return fetch(deleteUrl, { method: 'POST', headers: CSRF_TOKEN ? { 'X-CSRFToken': CSRF_TOKEN } : {} });
          }
          return resp;
        })
        .then(() => {
          const bs = bootstrap.Modal.getInstance(deleteModalEl);
          if (bs) bs.hide();
          window.location.reload();
        })
        .catch(err => {
          console.error('Delete failed', err);
          window.location.reload();
        });
    });
  })();

  // --------------------------
  // FILTER DROPDOWNS
  // --------------------------
  (function setupFilters() {
    const statusFilter = document.getElementById('clientFilterStatus');
    const priorityFilter = document.getElementById('clientFilterPriority');

    if (statusFilter) {
      statusFilter.addEventListener('change', function () {
        const params = new URLSearchParams(window.location.search);
        if (this.value) params.set('status', this.value); else params.delete('status');
        window.location.search = params.toString();
      });
    }
    if (priorityFilter) {
      priorityFilter.addEventListener('change', function () {
        const params = new URLSearchParams(window.location.search);
        if (this.value) params.set('priority', this.value); else params.delete('priority');
        window.location.search = params.toString();
      });
    }
  })();

  // --------------------------
  // PROGRESS BARS / GAMIFICATION
  // --------------------------
  (function setupProgressBars() {
    if (!hasFeature('gamification')) {
      // hide gamification card if present
      document.querySelectorAll('.card').forEach(card => {
        const header = card.querySelector('.card-header');
        if (header && header.textContent && header.textContent.trim().toLowerCase().includes('gamification')) {
          card.classList.add('d-none');
        }
      });
      return;
    }
    document.querySelectorAll('.progress-bar[data-points]').forEach(bar => {
      const value = parseInt(bar.dataset.points || '0', 10);
      bar.style.width = Math.max(0, Math.min(100, value)) + '%';
      bar.setAttribute('aria-valuenow', String(Math.max(0, Math.min(100, value))));
    });
  })();

  // --------------------------
  // HIDE SERVER-RENDERED BLOCKS IF DISABLED (defensive)
  // --------------------------
  (function defensiveHide() {
    if (!hasFeature('task_timer')) {
      const overlay = document.getElementById('inlineTimerOverlay');
      if (overlay) overlay.classList.add('d-none');
      document.querySelectorAll('.scroll-to-timer').forEach(b => b.classList.add('d-none'));
    }
    if (!hasFeature('task_export')) {
      document.querySelectorAll('#exportTasksBtn').forEach(b => b.classList.add('d-none'));
    }
    if (!hasFeature('tips')) {
      document.querySelectorAll('.card').forEach(card => {
        const header = card.querySelector('.card-header');
        if (header && /daily tips/i.test(header.textContent || '')) card.classList.add('d-none');
      });
    }
    if (!hasFeature('reminders')) {
      document.querySelectorAll('.card').forEach(card => {
        const header = card.querySelector('.card-header');
        if (header && /upcoming reminders/i.test(header.textContent || '')) card.classList.add('d-none');
      });
    }
  })();

}); // DOMContentLoaded

  // Summary card navigation (safe: uses data-href to avoid quote problems)
  (function setupSummaryCards() {
    const cards = document.querySelectorAll('.summary-card-btn');
    if (!cards || !cards.length) return;

    cards.forEach(card => {
      // click -> go to exact URL (data-href), fallback to craft query param
      card.addEventListener('click', () => {
        const href = card.dataset.href;
        if (href && href.length) {
          window.location.href = href;
          return;
        } 
        // fallback: use status param and keep other query params
        const status = card.dataset.status || 'all';
        const params = new URLSearchParams(window.location.search);
        if (status && status !== 'all') params.set('status', status);
        else params.delete('status');
        params.delete('page'); // reset pagination when switching view
        window.location.search = params.toString();
      });

      // keyboard activation for accessibility
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          card.click();
        }
      });
    });
  })();

  document.addEventListener('DOMContentLoaded', function () {
  // select only the summary buttons we just added
  const summaryBtns = document.querySelectorAll('.summary-card-btn');
  if (!summaryBtns || summaryBtns.length === 0) return;

  // find a suitable heading to update on click.
  // we'll try a few common selectors so this works across your templates.
  const headingSelectors = [
    '#dashboardHeading',        // explicit id if you have it
    'h1.display-5',             // dashboard_general / customized header
    'h1.display-4',             // dyslexia header versions
    'h1'                        // fallback to any H1
  ];
  let headerEl = null;
  for (const sel of headingSelectors) {
    const el = document.querySelector(sel);
    if (el) { headerEl = el; break; }
  }

  const titleMap = {
    all: 'All Tasks',
    pending: 'Pending',
    completed: 'Completed',
    overdue: 'Overdue'
  };

  function setActive(btn) {
    summaryBtns.forEach(b => b.classList.remove('active-summary'));
    btn.classList.add('active-summary');
  }

  // attach handlers
  summaryBtns.forEach(btn => {
    // keyboard accessibility
    btn.setAttribute('tabindex', '0');

    btn.addEventListener('click', function (e) {
      // prevent other delegated handlers from firing (you had problems with status toggles)
      e.preventDefault();
      e.stopPropagation();
      const href = btn.dataset.href;
      const status = btn.dataset.status;

      // immediate visual feedback: change heading
      if (headerEl && titleMap[status]) {
        headerEl.textContent = titleMap[status];
      }

      setActive(btn);

      // small delay so user sees change (optional) then navigate
      // You can remove the timeout if you want instant navigation.
      setTimeout(() => {
        if (href) window.location.href = href;
      }, 60);
    });

    // keyboard activation
    btn.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        btn.click();
      }
    });
  });

  // highlight currently active based on URL status param
  (function highlightCurrentFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const current = (params.get('status') || 'all').toLowerCase();
    summaryBtns.forEach(b => {
      if ((b.dataset.status || '').toLowerCase() === current) {
        setActive(b);
      }
    });
  })();
});
</script>

<style>
/* keep bootstrap border-* classes as source of truth (do NOT override border here) */
.summary-card-btn {
  border: 3px solid transparent;
  transition: transform 0.2s, border-color 0.2s;
}

.task-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s, border 0.2s;
    border: 2px solid transparent;
    border-radius: 12px;
}

/* hover lift without changing border width/size */
.summary-card-btn:hover {
  transform: scale(1.05);
  border-color: #888; /* Hover color */
}

.task-card:hover {
    transform: translateY(-5px);
    box-shadow: 0px 4px 10px rgba(0,0,0,0.15);
}


/* subtle active styling */
.summary-card-btn.active-summary {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

/* Active (selected) filter */
.task-card.active {
    border: 3px solid #007bff; /* default blue */
    box-shadow: 0px 6px 14px rgba(0,0,0,0.2);
}

/* ensure color-coded active border ‚Äî more specific to override bootstrap if needed */
.summary-card-btn.active-summary[data-status="all"] {
  border-color: #0d6efd !important;   /* blue */
}
.summary-card-btn.active-summary[data-status="pending"] {
  border-color: #ffc107 !important;   /* yellow */
}
.summary-card-btn.active-summary[data-status="completed"] {
  border-color: #28a745 !important;   /* green */
}
.summary-card-btn.active-summary[data-status="overdue"] {
  border-color: #dc3545 !important;   /* red */
}

/* Give each card its own border color when active */
.task-card.active:nth-child(1) { border-color: #007bff; } /* All Tasks = Blue */
.task-card.active:nth-child(2) { border-color: #ffc107; } /* Pending = Yellow */
.task-card.active:nth-child(3) { border-color: #28a745; } /* Completed = Green */
.task-card.active:nth-child(4) { border-color: #dc3545; } /* Overdue = Red */

/* keyboard focus accessibility */
.summary-card-btn:focus {
  outline: none;
  box-shadow: 0 0 0 4px rgba(13,110,253,0.12);
}
</style>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const summaryBtns = Array.from(document.querySelectorAll('.summary-card-btn'));
  if (!summaryBtns.length) return;

  // map for heading text when clicked
  const titleMap = {
    all: 'All Tasks',
    pending: 'Pending',
    completed: 'Completed',
    overdue: 'Overdue'
  };

  // find a heading to update visually (attempts common selectors)
  const headingSelectors = ['#dashboardHeading', 'h1.display-5', 'h1.display-4', 'h1'];
  let headerEl = null;
  for (const s of headingSelectors) {
    const el = document.querySelector(s);
    if (el) { headerEl = el; break; }
  }

  function setActive(btn) {
    summaryBtns.forEach(b => b.classList.remove('active-summary'));
    if (btn) btn.classList.add('active-summary');
  }

  // Highlight from current query param on page load
  (function highlightFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const current = (params.get('status') || 'all').toLowerCase();
    const match = summaryBtns.find(b => (b.dataset.status || '').toLowerCase() === current);
    if (match) setActive(match);
  })();

  // Attach handlers
  summaryBtns.forEach(btn => {
    // make keyboard focusable
    if (!btn.hasAttribute('tabindex')) btn.setAttribute('tabindex', '0');

    btn.addEventListener('click', function (e) {
      // quick visual title change
      const status = (this.dataset.status || 'all').toLowerCase();
      if (headerEl && titleMap[status]) headerEl.textContent = titleMap[status];
      setActive(this);

      // final navigation (create a normal history entry so Back works)
      const href = this.dataset.href;
      if (href) {
        // small delay to let the visual change register, then navigate
        setTimeout(() => { window.location.assign(href); }, 60);
      } else {
        // fallback: build URL with status param keeping other params
        const params = new URLSearchParams(window.location.search);
        if (status && status !== 'all') params.set('status', status); else params.delete('status');
        params.delete('page');
        const newUrl = window.location.pathname + '?' + params.toString();
        setTimeout(() => { window.location.assign(newUrl); }, 60);
      }
    });

    // allow Enter / Space to trigger
    btn.addEventListener('keydown', function (ev) {
      if (ev.key === 'Enter' || ev.key === ' ') {
        ev.preventDefault(); this.click();
      }
    });
  });
});


// --------------------------
// SUMMARY CARDS CLICK HANDLER
// --------------------------
(function setupSummaryCards() {
  document.querySelectorAll('.summary-card-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const href = this.dataset.href;
      if (href) {
        // Use replace() so history stays clean and back works
        window.location.replace(href);
      }
    });
  });
})();


</script>

{% endblock %}

{% endblock %}