{% extends "layout.html" %}
{% block content %}
<div class="container py-4">

  <!-- =========================================================
       HEADER
  ========================================================== -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="display-5 mb-1">Dashboard</h1>
      <p class="text-muted mb-0">Welcome back, {{ current_user.name or current_user.username }}!</p>
    </div>
    <div class="d-none d-md-block">
      {% for f in features %}
        <span class="badge bg-secondary me-1 text-capitalize">{{ f.replace('_',' ') }}</span>
      {% endfor %}
    </div>
  </div>

  <!-- =========================================================
       TOP STATS CARDS
  ========================================================== -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <div class="card h-100 border-primary">
        <div class="card-body text-center">
          <div class="h1 mb-0">{{ task_counts.total }}</div>
          <div class="text-muted">Total Tasks</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 border-warning">
        <div class="card-body text-center">
          <div class="h1 mb-0">{{ task_counts.pending }}</div>
          <div class="text-muted">Pending</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 border-success">
        <div class="card-body text-center">
          <div class="h1 mb-0">{{ task_counts.completed }}</div>
          <div class="text-muted">Completed</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 border-danger">
        <div class="card-body text-center">
          <div class="h1 mb-0">{{ task_counts.overdue }}</div>
          <div class="text-muted">Overdue</div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       ACTION BAR
  ========================================================== -->
  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
      <i class="bi bi-plus-lg"></i> New Task
    </button>

    <a href="{{ url_for('main.task_list') }}" class="btn btn-outline-secondary">
      <i class="bi bi-list-ul"></i> All Tasks
    </a>

    <a href="{{ url_for('main.onboarding') }}" class="btn btn-outline-info">
      <i class="bi bi-gear"></i> Preferences
    </a>

    {% if 'task_export' in features or current_user.feature_task_export %}
    <button id="exportTasksBtn" class="btn btn-outline-dark">
      <i class="bi bi-box-arrow-up-right"></i> Export
    </button>
    {% endif %}

    <div class="ms-auto d-flex flex-wrap gap-2">
      <form class="d-flex" method="get" action="{{ url_for('main.dashboard_customized') }}">
        <input name="q" value="{{ search_term or '' }}" class="form-control" placeholder="Search tasks‚Ä¶">
        <button class="btn btn-outline-secondary ms-2">Search</button>
      </form>
    </div>
  </div>

  <div class="row">
    <!-- =======================================================
         LEFT: TASK TABLE + RECENT ACTIVITY
    ======================================================== -->
    <div class="col-12 col-lg-8">
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>Tasks</strong>
          <div class="d-flex align-items-center gap-2">
            <select id="clientFilterStatus" class="form-select form-select-sm" style="width:auto">
              <option value="">All</option>
              <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending</option>
              <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
            <select id="clientFilterPriority" class="form-select form-select-sm" style="width:auto">
              <option value="">Any Priority</option>
              <option value="1" {% if filter_priority|string == '1' %}selected{% endif %}>High</option>
              <option value="2" {% if filter_priority|string == '2' %}selected{% endif %}>Medium</option>
              <option value="3" {% if filter_priority|string == '3' %}selected{% endif %}>Low</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th style="min-width:220px">Task</th>
                  <th>Due</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for task in paginated_tasks.items %}
                <tr>
                  <td>{{ task.title }}</td>
                  <td>{{ task.due_date.strftime('%Y-%m-%d %H:%M') if task.due_date else 'No due date' }}</td>
                  <td>
                    {% if task.priority == 1 %}
                      <span class="badge bg-danger">High</span>
                    {% elif task.priority == 2 %}
                      <span class="badge bg-warning text-dark">Medium</span>
                    {% elif task.priority == 3 %}
                      <span class="badge bg-secondary">Low</span>
                    {% else %}
                      <span class="badge bg-secondary">‚Äî</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if task.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                    {% elif task.status == 'in progress' %}
                        <span class="badge bg-info text-dark">In Progress</span>
                    {% elif task.status == 'not started' %}
                        <span class="badge bg-secondary">Not Started</span>
                    {% elif task.status == 'overdue' %}
                        <span class="badge bg-danger">Overdue</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ task.status }}</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-success scroll-to-timer" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}">
                      ‚è± Start
                    </button>
                    <a href="{{ url_for('main.edit_task', id=task.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è Edit</a>
                    <button class="btn btn-sm btn-danger delete-task-btn" data-task-id="{{ task.id }}" data-bs-toggle="modal" data-bs-target="#deleteTaskModal">üóëÔ∏è Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <!-- DELETE TASK MODAL -->
        <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTaskModalLabel">Delete Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTaskBtn">Delete</button>
            </div>
            </div>
        </div>
        </div>

      <!-- =======================================================
           RECENT ACTIVITY
      ======================================================== -->
      <div class="card mb-4">
        <div class="card-header"><strong>Recent Activity</strong></div>
        <ul class="list-group list-group-flush">
          {% for t in recent_tasks %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ t.title }}</strong>
              <div class="small text-muted">Due: {% if t.due_date %}{{ t.due_date.strftime('%b %d, %Y') }}{% else %}‚Äî{% endif %}</div>
            </div>
            <div class="text-end small">
              {% if t.completed %}
                <span class="text-success">Completed</span>
              {% else %}
                <span class="text-muted">Pending</span>
              {% endif %}
            </div>
          </li>
          {% else %}
          <li class="list-group-item text-muted">No recent activity</li>
          {% endfor %}
        </ul>
      </div>

      <!-- =======================================================
           INLINE FOCUS TIMER
      ======================================================== -->
      <div id="inlineTimerOverlay" class="d-none">
        <div id="inlineTimerModal" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" 
            style="background: rgba(0,0,0,0.7); z-index:1050;">
            <div class="card p-4 text-center" style="width: 400px; max-width:90%; border-radius: 1rem;">
            <h3 id="inlineTimerTitle">Task Timer</h3>
            <div class="my-4" style="font-size:4rem; font-weight:bold;" id="countdownDisplay">00:00</div>
            <form id="inlineTimerForm" class="mb-3">
                <input type="hidden" id="inlineTaskId">
                <div class="mb-3">
                <label for="inlineTimerMinutes" class="form-label">Minutes:</label>
                <input type="number" id="inlineTimerMinutes" class="form-control" placeholder="Enter minutes" min="1">
                </div>
                <button type="submit" class="btn btn-success w-100 mb-2">Start</button>
                <button type="button" class="btn btn-danger w-100" id="closeInlineTimer">Close</button>
            </form>
            </div>
        </div>
      </div>

    </div> <!-- End LEFT Column -->

    <!-- =======================================================
         RIGHT: FEATURE CARDS
    ======================================================== -->
    <div class="col-12 col-lg-4">

      <!-- =======================================================
           ADD TASK CARD (INLINE)
      ======================================================== -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title mb-3">Add Task</h5>
          <form method="post" action="{{ url_for('main.dashboard_customized') }}">
            {{ task_form.hidden_tag() }}
            <div class="mb-2">
              {{ task_form.title(class="form-control", placeholder="Task title") }}
              {% if task_form.title.errors %}
                <div class="text-danger small">{{ task_form.title.errors[0] }}</div>
              {% endif %}
            </div>
            <div class="mb-2">
              {{ task_form.description(class="form-control", placeholder="Description (optional)", rows="3") }}
            </div>
            <div class="mb-2">
              {{ task_form.due_date(class="form-control") }}
            </div>
            <div class="mb-2 d-flex gap-2 align-items-center">
              {{ task_form.priority(class="form-select w-50") }}
              <div class="form-check">
                {{ task_form.reminder_set(class="form-check-input", id="remSetInline") }}
                <label class="form-check-label small" for="remSetInline">Reminder</label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-2">
              <i class="bi bi-plus-lg"></i> Add Task
            </button>
          </form>
        </div>
      </div>

      <!-- =======================================================
           GAMIFICATION CARD
      ======================================================== -->
      {% if 'gamification' in features or current_user.feature_gamification %}
      <div class="card mb-3">
        <div class="card-header"><strong>Gamification</strong></div>
        <div class="card-body text-center">
          <div class="h2">{{ current_user.points|default(0) }}</div>
          <small class="text-muted">Points</small>
          <div class="mt-2">
            <div class="progress">
              <div class="progress-bar" role="progressbar"
                   data-points="{{ current_user.points_percentage|default(0)|int }}"
                   aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
          <small class="text-muted">Level {{ current_user.level|default(1) }}</small>
        </div>
      </div>
      {% endif %}

      <!-- =======================================================
           DAILY TIPS CARD
      ======================================================== -->
      {% if 'tips' in features or current_user.feature_tips %}
      <div class="card mb-3">
        <div class="card-header"><strong>Daily Tips</strong></div>
        <div class="card-body">
          {% for tip in daily_tips %}
            <p class="mb-2"><i class="bi bi-lightbulb-fill text-warning"></i> {{ tip }}</p>
          {% else %}
            <p class="text-muted mb-0">No tips for today.</p>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- =======================================================
           REMINDERS CARD
      ======================================================== -->
      {% if 'reminders' in features or current_user.feature_reminders %}
      <div class="card mb-3">
        <div class="card-header"><strong>Upcoming Reminders</strong></div>
        <ul class="list-group list-group-flush">
          {% for r in reminders %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ r.task.title }}</span>
              <small class="text-muted">{{ r.remind_at.strftime('%b %d %H:%M') }}</small>
            </li>
          {% else %}
            <li class="list-group-item text-muted">No upcoming reminders</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    </div> <!-- End RIGHT Column -->
  </div> <!-- End ROW -->

</div> <!-- End CONTAINER -->

<!-- =========================================================
     NEW TASK MODAL
========================================================== -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('main.dashboard_customized') }}">
        {{ task_form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="newTaskModalLabel">New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ task_form.title(class="form-control", placeholder="Task Title") }}
            {% if task_form.title.errors %}
              <div class="text-danger small">{{ task_form.title.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ task_form.description(class="form-control", placeholder="Description", rows="3") }}
          </div>
          <div class="mb-3">
            {{ task_form.due_date(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ task_form.priority(class="form-select") }}
          </div>
          <div class="form-check mb-3">
            {{ task_form.reminder_set(class="form-check-input", id="remSetModal") }}
            <label class="form-check-label" for="remSetModal">Set Reminder</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =========================================================
     CUSTOM SCRIPT SECTION
========================================================== -->
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

  // =========================================================
  // Export tasks
  // =========================================================
  const exportBtn = document.getElementById('exportTasksBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
      fetch('{{ url_for("main.export_tasks") }}')
        .then(r => r.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'tasks.json';
          document.body.appendChild(a);
          a.click();
          a.remove();
        })
        .catch(err => console.error("Export failed:", err));
    });
  }

  // =========================================================
  // Inline Timer
  // =========================================================
  const inlineOverlay = document.getElementById('inlineTimerOverlay');
  const countdownDisplay = document.getElementById('countdownDisplay');
  const inlineTimerForm = document.getElementById('inlineTimerForm');
  const inlineTaskIdInput = document.getElementById('inlineTaskId');
  const inlineTimerTitle = document.getElementById('inlineTimerTitle');
  let countdownInterval;

  // Timer expiration modal
  let timerExpiredModalHtml = `
    <div class="modal fade" id="timerExpiredModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">Time's Up!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Did you finish the task?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" id="timerYesBtn">Yes</button>
            <button type="button" class="btn btn-secondary" id="timerNoBtn">No</button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', timerExpiredModalHtml);
  const timerExpiredModalEl = document.getElementById('timerExpiredModal');
  const timerExpiredModal = new bootstrap.Modal(timerExpiredModalEl);
  let currentTaskId = null;

  // Show timer overlay on "Start" button click
  document.querySelectorAll('.scroll-to-timer').forEach(btn => {
    btn.addEventListener('click', function() {
      const taskId = this.dataset.taskId;
      const taskTitle = this.dataset.taskTitle;

      currentTaskId = taskId;
      inlineTaskIdInput.value = taskId;
      inlineTimerTitle.textContent = taskTitle;
      countdownDisplay.textContent = '00:00';
      inlineOverlay.classList.remove('d-none');

      // Set task status to "in progress" using AJAX
      updateTaskStatus(taskId, 'in progress');
    });
  });

  // Close timer overlay
  const closeInlineBtn = document.getElementById('closeInlineTimer');
  if (closeInlineBtn) {
    closeInlineBtn.addEventListener('click', () => {
      clearInterval(countdownInterval);
      inlineOverlay.classList.add('d-none');
    });
  }

  // Handle timer form submission
  if (inlineTimerForm) {
    inlineTimerForm.addEventListener('submit', function(e) {
      e.preventDefault();
      let minutes = parseInt(document.getElementById('inlineTimerMinutes').value);
      if (!minutes || minutes <= 0) minutes = 1;

      let secondsRemaining = minutes * 60;
      clearInterval(countdownInterval);

      countdownInterval = setInterval(() => {
        const m = Math.floor(secondsRemaining / 60);
        const s = secondsRemaining % 60;
        countdownDisplay.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

        if (secondsRemaining <= 0) {
          clearInterval(countdownInterval);
          // Show modal instead of confirm()
          timerExpiredModal.show();
        }
        secondsRemaining--;
      }, 1000);
    });
  }

  // =========================================================
  // Timer expired modal buttons
  // =========================================================
  document.getElementById('timerYesBtn').addEventListener('click', () => {
    if (!currentTaskId) return;
    updateTaskStatus(currentTaskId, 'completed');
    timerExpiredModal.hide();
    inlineOverlay.classList.add('d-none');
    location.reload();
  });

  document.getElementById('timerNoBtn').addEventListener('click', () => {
    timerExpiredModal.hide();
    inlineOverlay.classList.add('d-none');
  });

  // =========================================================
  // Update task status function
  // =========================================================
  function updateTaskStatus(taskId, status) {
  if (!taskId) return;
  const statusUrl = `{{ url_for("main.update_status", id=0) }}`.replace('0', taskId);
  const csrfInput = document.querySelector('input[name="csrf_token"]');
  const csrfToken = csrfInput ? csrfInput.value : '';

  fetch(statusUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({ status })
  })
  .then(response => {
    if (!response.ok) throw new Error("Status update failed");
    // Update badge in the DOM immediately
    const row = document.querySelector(`.scroll-to-timer[data-task-id='${taskId}']`)?.closest('tr');
    if (row) {
      const statusCell = row.querySelector('td:nth-child(4)');
      if (statusCell) {
        if (status === 'in progress') {
          statusCell.innerHTML = '<span class="badge bg-info text-dark">In Progress</span>';
        } else if (status === 'completed') {
          statusCell.innerHTML = '<span class="badge bg-success">Completed</span>';
        } else if (status === 'pending') {
          statusCell.innerHTML = '<span class="badge bg-secondary">Pending</span>';
        } else if (status === 'overdue') {
          statusCell.innerHTML = '<span class="badge bg-danger">Overdue</span>';
        }
      }
    }
  })
  .catch(err => console.error("Status update failed:", err));
}

  // =========================================================
  // Delete task modal handling
  // =========================================================
  let deleteTaskId = null;
  const deleteModal = document.getElementById('deleteTaskModal');
  const confirmDeleteBtn = document.getElementById('confirmDeleteTaskBtn');

  document.querySelectorAll('.delete-task-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      deleteTaskId = this.dataset.taskId;
    });
  });

  if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', function() {
      if (!deleteTaskId) return;
      const deleteUrl = `{{ url_for("main.delete_task", id=0) }}`.replace('0', deleteTaskId);
      const csrfInput = document.querySelector('input[name="csrf_token"]');
      const csrfToken = csrfInput ? csrfInput.value : '';

      fetch(deleteUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken }
      })
      .then(() => {
        deleteTaskId = null;
        const bsModal = bootstrap.Modal.getInstance(deleteModal);
        if (bsModal) bsModal.hide();
        location.reload();
      })
      .catch(err => console.error("Delete failed:", err));
    });
  }

  // =========================================================
  // Optional: filter dropdown change handling
  // =========================================================
  const statusFilter = document.getElementById('clientFilterStatus');
  const priorityFilter = document.getElementById('clientFilterPriority');
  [statusFilter, priorityFilter].forEach(el => {
    if (el) {
      el.addEventListener('change', () => {
        const params = new URLSearchParams(window.location.search);
        if (statusFilter) params.set('status', statusFilter.value);
        if (priorityFilter) params.set('priority', priorityFilter.value);
        window.location.search = params.toString();
      });
    }
  });

});
</script>
{% endblock %}

{% endblock %}
