{% extends "layout_adhd.html" %}

{% block content %}
<section aria-labelledby="dashboardHeading" class="my-5 adhd-mode">
    <div class="container">
        <h1 id="dashboardHeading" class="mb-4 display-4 text-primary">Dashboard (ADHD Mode)</h1>
        <p class="lead">Welcome back, {{ current_user.name or current_user.email }}!</p>

        <!-- Quick Big Focus Task Button -->
        <div class="text-center my-4">
            <button id="enterFocusMode" class="btn btn-lg btn-success px-5 py-3">
                <i class="fa-solid fa-bullseye me-2"></i> Start Focus Mode
            </button>
        </div>

        <!-- Task Summary -->
        <div class="row g-4 my-4" role="region" aria-label="Task summary">
            <div class="col-md-3 col-sm-6">
                <div class="card shadow-sm border-primary h-100 text-center">
                    <div class="card-body">
                        <h2>{{ task_counts.total }}</h2>
                        <p>Total Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card shadow-sm border-warning h-100 text-center">
                    <div class="card-body">
                        <h2>{{ task_counts.pending }}</h2>
                        <p>Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card shadow-sm border-success h-100 text-center">
                    <div class="card-body">
                        <h2>{{ task_counts.completed }}</h2>
                        <p>Completed</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card shadow-sm border-danger h-100 text-center">
                    <div class="card-body">
                        <h2>{{ task_counts.overdue }}</h2>
                        <p>Overdue</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="d-flex flex-wrap gap-3 my-4">
            <a href="{{ url_for('views.create_task') }}" class="btn btn-lg btn-primary">
                <i class="fa-solid fa-plus me-2"></i> New Task
            </a>
            <a href="{{ url_for('views.task_list') }}" class="btn btn-lg btn-outline-secondary">
                <i class="fa-solid fa-list me-2"></i> All Tasks
            </a>
            <a href="{{ url_for('views.onboarding') }}" class="btn btn-lg btn-outline-info">
                <i class="fa-solid fa-gear me-2"></i> Preferences
            </a>
        </div>

        <!-- Recent Tasks -->
        <div class="table-responsive shadow-sm border rounded">
            <table class="table align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Task</th>
                        <th>Due</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_tasks %}
                        {% for task in recent_tasks %}
                        {% set task_local_due = task.due_date.replace(tzinfo=pytz.UTC).astimezone(pytz.timezone('US/Pacific')) if task.due_date else None %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task_local_due.strftime('%b %d, %Y') if task_local_due else 'No due date' }}</td>
                            <td>
                                {% if task.priority == 1 %}<span class="badge bg-danger">High</span>
                                {% elif task.priority == 2 %}<span class="badge bg-warning text-dark">Medium</span>
                                {% elif task.priority == 3 %}<span class="badge bg-secondary">Low</span>
                                {% else %}<span class="badge bg-secondary">Unknown</span>{% endif %}
                            </td>
                            <td>
                                {% if task.completed %}<span class="badge bg-success">Completed</span>
                                {% else %}<span class="badge bg-info text-dark">Pending</span>{% endif %}
                            </td>
                            <td class="text-center">
                                {% if not task.completed %}
                                <button type="button" class="btn btn-sm btn-success start-task-btn" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}">
                                    ▶ Start Task
                                </button>
                                {% endif %}
                                <a href="{{ url_for('views.edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-task" data-task-id="{{ task.id }}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No recent tasks found. Start by creating a new task!</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Task Timer Section -->
        <div id="task-timer-section" class="mt-4" style="display:none;">
            <div class="d-flex">
                <div class="flex-grow-1 me-3">
                    <div class="card shadow-sm p-3">
                        <h5>Set Task Duration</h5>
                        <p id="selected-task-name" class="text-muted">No task selected</p>
                        <label for="timeInput" class="form-label">Estimated Time (minutes)</label>
                        <input type="number" id="timeInput" class="form-control" min="1" placeholder="e.g., 25">
                        <button class="btn btn-success mt-2" id="start-timer">Start</button>
                    </div>
                </div>
                <div class="flex-shrink-0" style="width:35%;">
                    <div class="card shadow-sm p-3">
                        <h5 class="text-center">Task Timer</h5>
                        <div id="timer-display" class="display-4 text-center">00:00</div>
                        <div id="timer-status" class="text-center text-muted">Idle</div>
                        <div class="d-flex justify-content-between gap-2 mt-3">
                            <button class="btn btn-warning flex-fill" id="pause-timer">⏸ Pause</button>
                            <button class="btn btn-primary flex-fill" id="resume-timer">▶ Resume</button>
                            <button class="btn btn-danger flex-fill" id="stop-timer">⏹ Stop</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTaskModalLabel">Confirm Task Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <form id="deleteTaskForm" method="POST" novalidate>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block body_scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // --- DELETE TASK MODAL ---
    const deleteModal = document.getElementById('deleteTaskModal');
    const deleteForm = document.getElementById('deleteTaskForm');
    document.querySelectorAll('.btn-delete-task').forEach(btn => {
        btn.addEventListener('click', () => {
            const taskId = btn.getAttribute('data-task-id');
            deleteForm.action = `/task/delete/${taskId}`;
            const modal = new bootstrap.Modal(deleteModal);
            modal.show();
        });
    });

    // --- TASK TIMER ---
    const startTaskButtons = document.querySelectorAll('.start-task-btn');
    const taskTimerSection = document.getElementById('task-timer-section');
    const selectedTaskName = document.getElementById('selected-task-name');
    const timerDisplay = document.getElementById('timer-display');
    const timerStatus = document.getElementById('timer-status');
    const startTimerBtn = document.getElementById('start-timer');
    const pauseBtn = document.getElementById('pause-timer');
    const resumeBtn = document.getElementById('resume-timer');
    const stopBtn = document.getElementById('stop-timer');

    let timerInterval = null;
    let remainingTime = 0;
    let paused = false;

    function formatTime(s) {
        const m = Math.floor(s / 60).toString().padStart(2,"0");
        const sec = (s % 60).toString().padStart(2,"0");
        return `${m}:${sec}`;
    }

    function startTimer(minutes) {
        remainingTime = minutes * 60;
        timerStatus.textContent = 'Running';
        timerDisplay.textContent = formatTime(remainingTime);

        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (!paused) {
                remainingTime--;
                timerDisplay.textContent = formatTime(remainingTime);
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    timerStatus.textContent = 'Completed!';
                    timerDisplay.textContent = '00:00';
                }
            }
        }, 1000);
    }

    startTaskButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const title = btn.dataset.taskTitle;
            selectedTaskName.textContent = title;
            taskTimerSection.style.display = 'block';
            taskTimerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });

    startTimerBtn.addEventListener('click', () => {
        const minutes = parseInt(document.getElementById('timeInput').value) || 25;
        startTimer(minutes);
    });

    pauseBtn.addEventListener('click', () => { paused = true; timerStatus.textContent='Paused'; });
    resumeBtn.addEventListener('click', () => { paused = false; timerStatus.textContent='Running'; });
    stopBtn.addEventListener('click', () => {
        clearInterval(timerInterval);
        timerDisplay.textContent = '00:00';
        timerStatus.textContent = 'Idle';
    });

});
</script>
{% endblock %}
