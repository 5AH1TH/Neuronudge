{% extends "layout_adhd.html" %}

{% block content %}
<section class="my-5">
  <h1 class="display-4 text-primary">Dashboard (ADHD Mode)</h1>
  <p class="lead">Welcome back, {{ current_user.name or current_user.email }}!</p>

  <!-- Quick Big Focus Task Button -->
  <div class="text-center my-4">
    <button id="enterFocusMode" class="btn btn-lg btn-success px-5 py-3">
      <i class="fa-solid fa-bullseye me-2"></i> Start Focus Mode
    </button>
  </div>

  <!-- Task Summary -->
  <div class="row g-4 my-4">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-primary h-100 text-center">
        <div class="card-body">
          <h2>{{ task_counts.total }}</h2>
          <p>Total Tasks</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-warning h-100 text-center">
        <div class="card-body">
          <h2>{{ task_counts.pending }}</h2>
          <p>Pending</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-success h-100 text-center">
        <div class="card-body">
          <h2>{{ task_counts.completed }}</h2>
          <p>Completed</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-danger h-100 text-center">
        <div class="card-body">
          <h2>{{ task_counts.overdue }}</h2>
          <p>Overdue</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="d-flex flex-wrap gap-3 my-4">
    <a href="{{ url_for('main.create_task') }}" class="btn btn-lg btn-primary">
      <i class="fa-solid fa-plus me-2"></i> New Task
    </a>
    <a href="{{ url_for('main.task_list') }}" class="btn btn-lg btn-outline-secondary">
      <i class="fa-solid fa-list me-2"></i> All Tasks
    </a>
    <a href="{{ url_for('main.onboarding') }}" class="btn btn-lg btn-outline-info">
      <i class="fa-solid fa-gear me-2"></i> Preferences
    </a>
  </div>

  <!-- Recent Tasks -->
  <div class="table-responsive shadow-sm border rounded">
    <table class="table align-middle">
      <thead class="table-light">
        <tr>
          <th>Task</th>
          <th>Due</th>
          <th>Priority</th>
          <th>Status</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if recent_tasks %}
            {% for task in recent_tasks[:3] %}
            <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.due_date.strftime('%b %d, %Y') if task.due_date else 'No due date' }}</td>
                <td>
                    {% if task.priority == 1 %}
                        <span class="badge bg-danger">High</span>
                    {% elif task.priority == 2 %}
                        <span class="badge bg-warning text-dark">Medium</span>
                    {% elif task.priority == 3 %}
                        <span class="badge bg-secondary">Low</span>
                    {% else %}
                        <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.status == "Late" %}
                        <span class="badge bg-danger">Late</span>
                    {% elif task.status == "Completed" %}
                        <span class="badge bg-success">Completed</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Pending</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <button
                        type="button"
                        class="btn btn-sm btn-success start-task-btn"
                        data-task-id="{{ task.id }}"
                        data-task-title="{{ task.title }}"
                    >
                        ▶ Start Task
                    </button>
                    <a href="{{ url_for('main.edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary" aria-label="Edit task {{ task.title }}">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-task" data-task-id="{{ task.id }}" aria-label="Delete task {{ task.title }}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}

            {% if recent_tasks|length > 3 %}
            <tr class="table-light">
                <td colspan="5" class="text-center">
                    <a href="{{ url_for('main.all_tasks') }}" class="text-decoration-none fw-bold">
                        … View all tasks
                    </a>
                </td>
            </tr>
            {% endif %}
        {% else %}
        <tr>
            <td colspan="5" class="text-center text-muted">
                No recent tasks found. Start by creating a new task!
            </td>
        </tr>
        {% endif %}
    </tbody>

    </table>
  </div>

  <!-- Timer + Form (hidden until Start Task pressed) -->
  <div id="task-timer-section" class="mt-4" style="display:none;">
    <div class="d-flex">
      <!-- LEFT: form -->
      <div class="flex-grow-1 me-3">
        <div class="card shadow-sm p-3">
          <h5>Set Task Duration</h5>
          <p id="selected-task-name" class="text-muted">No task selected</p>
          <label for="timeInput" class="form-label">Estimated Time (minutes)</label>
          <input type="number" id="timeInput" class="form-control" min="1" placeholder="e.g., 25">
          <button class="btn btn-success mt-2" id="start-timer">Start</button>
        </div>
      </div>
      <!-- RIGHT: timer -->
      <div class="flex-shrink-0" style="width:35%;">
        <div class="card shadow-sm p-3">
          <h5 class="text-center">Task Timer</h5>
          <div id="timer-display" class="display-4 text-center">00:00</div>
          <div id="timer-status" class="text-center text-muted">Idle</div>
          <div class="d-flex justify-content-between gap-2 mt-3">
            <button class="btn btn-warning flex-fill" id="pause-timer">⏸ Pause</button>
            <button class="btn btn-primary flex-fill" id="resume-timer">▶ Resume</button>
            <button class="btn btn-danger flex-fill" id="stop-timer">⏹ Stop</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Focus Mode Overlay (created here if not present in layout) -->
<div id="focus-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1055;">
  <div class="d-flex h-100 align-items-center justify-content-center">
    <div class="card shadow p-4 text-center" style="max-width:480px; width:90%;">
      <h3 class="mb-3 text-primary">Focus Mode</h3>
      <div id="focus-timer-display" class="display-3 mb-2">25:00</div>
      <div class="mb-3 text-muted">Stay with the task—you're doing great!</div>
      <div class="d-flex gap-2 justify-content-center">
        <button class="btn btn-warning" id="pause-focus">⏸ Pause</button>
        <button class="btn btn-primary" id="resume-focus">▶ Resume</button>
        <button class="btn btn-outline-light" id="exit-focus">Exit</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
/* ---------- Utilities ---------- */
function nnFormatTime(totalSeconds){
  const m = Math.floor(totalSeconds/60).toString().padStart(2,'0');
  const s = (totalSeconds%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

/* ---------- Delete Modal Wiring (works everywhere) ---------- */
document.addEventListener('DOMContentLoaded', function(){
  const deleteModalEl = document.getElementById('deleteTaskModal') || (function(){
    // Create a modal if the layout didn't include one yet
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="deleteTaskModalLabel">Confirm Task Deletion</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close modal"></button>
            </div>
            <div class="modal-body">Are you sure you want to delete this task? This action cannot be undone.</div>
            <div class="modal-footer">
              <form id="deleteTaskForm" method="POST" novalidate>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete</button>
              </form>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(wrap.firstElementChild);
    return document.getElementById('deleteTaskModal');
  })();

  const deleteForm = document.getElementById('deleteTaskForm');
  document.querySelectorAll('.btn-delete-task').forEach(button=>{
    button.addEventListener('click', ()=>{
      const tid = button.getAttribute('data-task-id');
      if(deleteForm){ deleteForm.action = `/task/delete/${tid}`; }
      const modal = new bootstrap.Modal(deleteModalEl);
      modal.show();
    });
  });
});

/* ---------- Focus Mode Overlay ---------- */
document.addEventListener('DOMContentLoaded', function(){
  const overlay = document.getElementById('focus-overlay');
  const enterBtn = document.getElementById('enterFocusMode');
  const focusDisplay = document.getElementById('focus-timer-display');
  const pauseBtn = document.getElementById('pause-focus');
  const resumeBtn = document.getElementById('resume-focus');
  const exitBtn = document.getElementById('exit-focus');

  let fmInterval = null;
  let fmRemaining = 25*60;
  let fmPaused = false;

  function fmStart(minutes){
    fmRemaining = (minutes||25)*60;
    focusDisplay.textContent = nnFormatTime(fmRemaining);
    clearInterval(fmInterval);
    fmInterval = setInterval(()=>{
      if(!fmPaused){
        fmRemaining--;
        focusDisplay.textContent = nnFormatTime(fmRemaining);
        if(fmRemaining<=0){
          clearInterval(fmInterval);
          focusDisplay.textContent = '00:00';
        }
      }
    },1000);
  }

  if(enterBtn){
    enterBtn.addEventListener('click', ()=>{
      overlay.style.display = 'block';
      document.body.classList.add('overflow-hidden');
      fmPaused = false;
      fmStart(25);
      // auto-scroll overlay into view (mobile)
      overlay.scrollIntoView({behavior:'smooth', block:'center'});
    });
  }

  if(pauseBtn){ pauseBtn.addEventListener('click', ()=>{ fmPaused = true; }); }
  if(resumeBtn){ resumeBtn.addEventListener('click', ()=>{ fmPaused = false; }); }
  if(exitBtn){
    exitBtn.addEventListener('click', ()=>{
      clearInterval(fmInterval);
      overlay.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    });
  }
});

/* ---------- Per-Task Timer Panel ---------- */
document.addEventListener('DOMContentLoaded', function(){
  const startBtns = document.querySelectorAll('.start-task-btn');
  const timerSection = document.getElementById('task-timer-section');
  const taskNameEl = document.getElementById('selected-task-name');
  const timeInput = document.getElementById('timeInput');

  const timerDisplay = document.getElementById('timer-display');
  const timerStatus = document.getElementById('timer-status');
  const startBtn = document.getElementById('start-timer');
  const pauseBtn = document.getElementById('pause-timer');
  const resumeBtn = document.getElementById('resume-timer');
  const stopBtn = document.getElementById('stop-timer');

  let interval = null;
  let remaining = 0;
  let paused = false;

  function startCountdown(mins){
    remaining = (mins||25)*60;
    paused = false;
    timerStatus.textContent = 'Running';
    timerDisplay.textContent = nnFormatTime(remaining);
    clearInterval(interval);
    interval = setInterval(()=>{
      if(!paused){
        remaining--;
        timerDisplay.textContent = nnFormatTime(remaining);
        if(remaining<=0){
          clearInterval(interval);
          timerStatus.textContent = 'Completed!';
          timerDisplay.textContent = '00:00';
        }
      }
    }, 1000);
  }

  startBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const title = btn.dataset.taskTitle || 'Selected Task';
      if(taskNameEl){ taskNameEl.textContent = title; }
      if(timerSection){
        timerSection.style.display = 'block';
        timerSection.scrollIntoView({behavior:'smooth', block:'start'});
      }
      const mins = parseInt(timeInput?.value) || 25;
      startCountdown(mins);
    });
  });

  if(startBtn){
    startBtn.addEventListener('click', ()=>{
      const mins = parseInt(timeInput?.value) || 25;
      startCountdown(mins);
    });
  }
  if(pauseBtn){ pauseBtn.addEventListener('click', ()=>{ paused = true; timerStatus.textContent='Paused'; }); }
  if(resumeBtn){ resumeBtn.addEventListener('click', ()=>{ paused = false; timerStatus.textContent='Running'; }); }
  if(stopBtn){
    stopBtn.addEventListener('click', ()=>{
      clearInterval(interval);
      timerDisplay.textContent = '00:00';
      timerStatus.textContent = 'Idle';
    });
  }
});
</script>

<!-- Delete Confirmation Modal (kept at bottom; used by the wiring above) -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteTaskModalLabel">Confirm Task Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close modal"></button>
      </div>
      <div class="modal-body">Are you sure you want to delete this task? This action cannot be undone.</div>
      <div class="modal-footer">
        <form id="deleteTaskForm" method="POST" novalidate>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
