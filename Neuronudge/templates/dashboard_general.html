{% extends "layout.html" %}

{% block content %}

<section aria-labelledby="dashboardHeading" class="my-5">
    <div class="container" id="dashboard-container">
        <h1 id="dashboardHeading" class="mb-4 display-4 text-primary">Dashboard</h1>
        <p class="lead">Welcome back, {{ current_user.name or current_user.email }}!</p>

        <div class="row g-4 my-4">
            <!-- Summary Cards -->
            <div class="col-md-3 col-sm-6" role="region" aria-label="Tasks summary">
                <a href="{{ url_for('main.all_tasks', filter='all') }}" class="text-decoration-none">
                    <div class="card shadow-sm border-primary h-100 summary-card">
                        <div class="card-body text-center">
                            <h2 class="card-title display-5">{{ task_counts.total }}</h2>
                            <p class="card-text fs-5">Total Tasks</p>
                        </div>
                    </div>
                </a>
            </div>
            
            <div class="col-md-3 col-sm-6" role="region" aria-label="Pending tasks summary">
                <a href="{{ url_for('main.all_tasks', filter='pending') }}" class="text-decoration-none">
                    <div class="card shadow-sm border-warning h-100 summary-card">
                        <div class="card-body text-center">
                            <h2 class="card-title display-5">{{ task_counts.pending }}</h2>
                            <p class="card-text fs-5">Pending Tasks</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3 col-sm-6" role="region" aria-label="Completed tasks summary">
                <a href="{{ url_for('main.all_tasks', filter='completed') }}" class="text-decoration-none">
                    <div class="card shadow-sm border-success h-100 summary-card">
                        <div class="card-body text-center">
                            <h2 class="card-title display-5">{{ task_counts.completed }}</h2>
                            <p class="card-text fs-5">Completed Tasks</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3 col-sm-6" role="region" aria-label="Overdue tasks summary">
                <a href="{{ url_for('main.all_tasks', filter='overdue') }}" class="text-decoration-none">
                    <div class="card shadow-sm border-danger h-100 summary-card">
                        <div class="card-body text-center">
                            <h2 class="card-title display-5">{{ task_counts.overdue }}</h2>
                            <p class="card-text fs-5">Overdue Tasks</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="d-flex flex-wrap gap-3 my-4" role="region" aria-label="Quick actions">
            <a href="{{ url_for('main.create_task') }}" class="btn btn-lg btn-primary" aria-label="Create new task">
                <i class="fa-solid fa-plus me-2"></i> New Task
            </a>

            <a href="{{ url_for('main.all_tasks') }}" class="btn btn-lg btn-outline-secondary" aria-label="View all tasks">
                <i class="fa-solid fa-list me-2"></i> All Tasks
            </a>

            <a href="{{ url_for('main.onboarding') }}" class="btn btn-lg btn-outline-info" aria-label="Open preferences">
                <i class="bi bi-gear me-2"></i> Preferences
            </a>

            {% if current_user.profile != 'ADHD' %}
            <a href="{{ url_for('main.dashboard_graphs') }}" class="btn btn-lg btn-outline-primary" aria-label="View task graphs">
                <i class="bi bi-bar-chart me-2"></i> Graphs
            </a>

            {% endif %}
        </div>


        <!-- Task Overview Table -->
        <div class="table-responsive shadow-sm rounded border mb-5">
            <table class="table table-hover align-middle mb-0" aria-describedby="taskOverviewDesc">
                <caption id="taskOverviewDesc">Summary of your most recent tasks with status and due dates.</caption>
                <thead class="table-light">
                    <tr>
                        <th scope="col">Task Name</th>
                        <th scope="col">Due Date</th>
                        <th scope="col">Priority</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_tasks %}
                        {% for task in recent_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.due_date.strftime('%b %d, %Y') if task.due_date else 'No due date' }}</td>
                            <td>
                                {% if task.priority == 1 %}
                                    <span class="badge bg-danger">High</span>
                                {% elif task.priority == 2 %}
                                    <span class="badge bg-warning text-dark">Medium</span>
                                {% elif task.priority == 3 %}
                                    <span class="badge bg-secondary">Low</span>
                                {% else %}
                                    <span class="badge bg-secondary">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.status == "Late" %}
                                    <span class="badge bg-danger">Late</span>
                                {% elif task.status == "Completed" %}
                                    <span class="badge bg-success">Completed</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Pending</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <!-- NEW Start Task button -->
                                <button
                                    type="button"
                                    class="btn btn-sm btn-success start-task-btn"
                                    data-task-id="{{ task.id }}"
                                    data-task-title="{{ task.title }}"
                                >
                                    ▶ Start Task
                                </button>
                                <a href="{{ url_for('main.edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary" aria-label="Edit task {{ task.title }}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-task" data-task-id="{{ task.id }}" aria-label="Delete task {{ task.title }}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No recent tasks found. Start by creating a new task!</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Timer + Form (hidden until Start Task pressed) -->
        <div id="task-timer-section" class="mt-4" style="display:none;">
            <div class="d-flex">
                <!-- LEFT: form -->
                <div class="flex-grow-1 me-3">
                    <div class="card shadow-sm p-3">
                        <h5>Set Task Duration</h5>
                        <p id="selected-task-name" class="text-muted">No task selected</p>
                        <label for="timeInput" class="form-label">Estimated Time (minutes)</label>
                        <input type="number" id="timeInput" class="form-control" min="1" placeholder="e.g., 25">
                        <button class="btn btn-success mt-2" id="start-timer">Start</button>
                    </div>
                </div>
                <!-- RIGHT: timer -->
                <div class="flex-shrink-0" style="width:35%;">
                    <div class="card shadow-sm p-3">
                        <h5 class="text-center">Task Timer</h5>
                        <div id="timer-display" class="display-4 text-center">00:00</div>
                        <div id="timer-status" class="text-center text-muted">Idle</div>
                        <div class="d-flex justify-content-between gap-2 mt-3">
                            <button class="btn btn-warning flex-fill" id="pause-timer">⏸ Pause</button>
                            <button class="btn btn-primary flex-fill" id="resume-timer">▶ Resume</button>
                            <button class="btn btn-danger flex-fill" id="stop-timer">⏹ Stop</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Feed -->
        <section aria-labelledby="activityFeedHeading" class="mb-5">
            <h2 id="activityFeedHeading" class="h3 mb-3 text-secondary">Recent Activity</h2>
            {% if recent_activity %}
            <ul class="list-group list-group-flush">
                {% for activity in recent_activity %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fa-solid fa-history text-muted me-2"></i>
                        {{ activity.description }}
                    </div>
                    <small class="text-muted">{{ activity.timestamp.strftime('%b %d, %Y %H:%M') }}</small>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted fst-italic">No recent activity to show.</p>
            {% endif %}
        </section>

        <!-- Tips & Tricks -->
        <section aria-labelledby="tipsHeading" class="bg-light p-4 rounded shadow-sm">
            <h2 id="tipsHeading" class="h3 mb-3 text-secondary">Tips & Tricks</h2>
            <ul class="list-unstyled">
                <li class="mb-2">
                    <i class="fa-solid fa-lightbulb text-warning me-2"></i>
                    Try breaking large tasks into smaller, manageable chunks.
                </li>
                <li class="mb-2">
                    <i class="fa-solid fa-bell text-info me-2"></i>
                    Enable notifications to get timely reminders.
                </li>
                <li class="mb-2">
                    <i class="fa-solid fa-check-double text-success me-2"></i>
                    Mark tasks as completed to keep track of your progress.
                </li>
                <li class="mb-2">
                    <i class="fa-solid fa-clock text-primary me-2"></i>
                    Set realistic due dates to avoid last-minute stress.
                </li>
            </ul>
        </section>
    </div>
</section>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTaskModalLabel">Confirm Task Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <form id="deleteTaskForm" method="POST" novalidate>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script id="timer-config" type="application/json">
{
  "focusMinutes": {{ (current_user.preferences.focus_time|default(25,true))|int }},
  "breakMinutes": {{ (current_user.preferences.break_time|default(5,true))|int }}
}
</script>
<script src="{{ url_for('static', filename='css/js/timer.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const deleteModal = document.getElementById('deleteTaskModal');
        const deleteForm = document.getElementById('deleteTaskForm');

        document.querySelectorAll('.btn-delete-task').forEach(button => {
            button.addEventListener('click', () => {
                const taskId = button.getAttribute('data-task-id');
                deleteForm.action = `/task/delete/${taskId}`;
                const modal = new bootstrap.Modal(deleteModal);
                modal.show();
            });
        });
    });
</script>

<style>
    /* Hover effect – fill with 25% opacity color */
    .summary-card-btn:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 22px rgba(0,0,0,0.15);
    }
</style>
<style>

</style>
{% endblock %}
