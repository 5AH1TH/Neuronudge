{% extends "layout_dyslexia.html" %}

{% block content %}
<section aria-labelledby="dashboardHeading" class="my-5 dyslexia-mode">
    <div class="container">
        <h1 id="dashboardHeading" class="mb-4 display-4 text-primary">Dashboard</h1>
        <p class="lead">Welcome back, {{ current_user.name or current_user.email }}!</p>

        <div class="row g-4 my-4">
            <!-- Summary Cards -->
            <div class="col-md-3 col-sm-6" role="region" aria-label="Tasks summary">
                <div class="card shadow-sm border-primary h-100">
                    <div class="card-body text-center">
                        <h2 class="card-title display-5">{{ task_counts.total }}</h2>
                        <p class="card-text fs-5">Total Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6" role="region" aria-label="Pending tasks summary">
                <div class="card shadow-sm border-warning h-100">
                    <div class="card-body text-center">
                        <h2 class="card-title display-5">{{ task_counts.pending }}</h2>
                        <p class="card-text fs-5">Pending Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6" role="region" aria-label="Completed tasks summary">
                <div class="card shadow-sm border-success h-100">
                    <div class="card-body text-center">
                        <h2 class="card-title display-5">{{ task_counts.completed }}</h2>
                        <p class="card-text fs-5">Completed Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6" role="region" aria-label="Overdue tasks summary">
                <div class="card shadow-sm border-danger h-100">
                    <div class="card-body text-center">
                        <h2 class="card-title display-5">{{ task_counts.overdue }}</h2>
                        <p class="card-text fs-5">Overdue Tasks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="d-flex flex-wrap gap-3 my-4" role="region" aria-label="Quick actions">
            <a href="{{ url_for('views.create_task') }}" class="btn btn-lg btn-primary" aria-label="Create new task">
                <i class="fa-solid fa-plus"></i> New Task
            </a>
            <a href="{{ url_for('views.task_list') }}" class="btn btn-lg btn-outline-secondary" aria-label="View all tasks">
                <i class="fa-solid fa-list"></i> All Tasks
            </a>
            <a href="{{ url_for('views.onboarding') }}" class="btn btn-lg btn-outline-info" aria-label="Update preferences">
                <i class="fa-solid fa-gear"></i> Preferences
            </a>
        </div>

        <!-- Task Overview Table -->
        <div class="table-responsive shadow-sm rounded border mb-5">
            <table class="table table-hover align-middle mb-0" aria-describedby="taskOverviewDesc">
                <caption id="taskOverviewDesc">Summary of your most recent tasks with status and due dates.</caption>
                <thead class="table-light">
                    <tr>
                        <th scope="col">Task Name</th>
                        <th scope="col">Due Date</th>
                        <th scope="col">Priority</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_tasks %}
                        {% for task in recent_tasks %}
                        {% set task_local_due = task.due_date.replace(tzinfo=pytz.UTC).astimezone(pytz.timezone('US/Pacific')) if task.due_date else None %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task_local_due.strftime('%b %d, %Y') if task_local_due else 'No due date' }}</td>
                            <td>
                                {% if task.priority == 1 %}<span class="badge bg-danger">High</span>
                                {% elif task.priority == 2 %}<span class="badge bg-warning text-dark">Medium</span>
                                {% elif task.priority == 3 %}<span class="badge bg-secondary">Low</span>
                                {% else %}<span class="badge bg-secondary">Unknown</span>{% endif %}
                            </td>
                            <td>
                                {% if task.completed %}
                                    <span class="badge bg-success">Completed</span>
                                {% else %}
                                    <span class="badge bg-info text-dark">Pending</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('views.edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-delete-task" data-task-id="{{ task.id }}">Delete</button>

                                {% if not task.completed %}
                                <button
                                    type="button"
                                    class="btn btn-sm btn-success start-task-btn"
                                    data-task-id="{{ task.id }}"
                                    data-task-title="{{ task.title }}"
                                >
                                    ▶ Start Task
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No recent tasks found. Start by creating a new task!</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Timer + Form (hidden until Start Task pressed) -->
        <div id="task-timer-section" class="mt-4" style="display:none;">
            <div class="d-flex">
                <div class="flex-grow-1 me-3">
                    <div class="card shadow-sm p-3">
                        <h5>Set Task Duration</h5>
                        <p id="selected-task-name" class="text-muted">No task selected</p>
                        <label for="timeInput" class="form-label">Estimated Time (minutes)</label>
                        <input type="number" id="timeInput" class="form-control" min="1" placeholder="e.g., 25">
                        <button class="btn btn-success mt-2" id="start-timer">Start</button>
                    </div>
                </div>
                <div class="flex-shrink-0" style="width:35%;">
                    <div class="card shadow-sm p-3">
                        <h5 class="text-center">Task Timer</h5>
                        <div id="timer-display" class="display-4 text-center">00:00</div>
                        <div id="timer-status" class="text-center text-muted">Idle</div>
                        <div class="d-flex justify-content-between gap-2 mt-3">
                            <button class="btn btn-warning flex-fill" id="pause-timer">⏸ Pause</button>
                            <button class="btn btn-primary flex-fill" id="resume-timer">▶ Resume</button>
                            <button class="btn btn-danger flex-fill" id="stop-timer">⏹ Stop</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Feed -->
        <section aria-labelledby="activityFeedHeading" class="mb-5">
            <h2 id="activityFeedHeading" class="h3 mb-3 text-secondary">Recent Activity</h2>
            {% if recent_activity %}
            <ul class="list-group list-group-flush">
                {% for activity in recent_activity %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fa-solid fa-history text-muted"></i>
                        {{ activity.description }}
                    </div>
                    <small class="text-muted">{{ activity.timestamp.strftime('%b %d, %Y %H:%M') }}</small>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No recent activity to show.</p>
            {% endif %}
        </section>

        <!-- Tips & Tricks -->
        <section aria-labelledby="tipsHeading" class="bg-light p-4 rounded shadow-sm">
            <h2 id="tipsHeading" class="h3 mb-3 text-secondary">Tips & Tricks</h2>
            <ul class="list-unstyled">
                <li class="mb-2">
                    <i class="fa-solid fa-lightbulb text-warning"></i>
                    Try breaking large tasks into smaller, manageable chunks.
                </li>
                <li class="mb-2">
                    <i class="fa-solid fa-bell text-info"></i>
                    Enable notifications to get timely reminders.
                </li>
                <li class="mb-2">
                    <i class="fa-solid fa-check-double text-success"></i>
                    Mark tasks as completed to keep track of your progress.
                </li>
                <li class="mb-2">
                    <i class="fa-solid fa-clock text-primary"></i>
                    Set realistic due dates to avoid last-minute stress.
                </li>
            </ul>
        </section>
    </div>
</section>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTaskModalLabel">Confirm Task Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <form id="deleteTaskForm" method="POST" novalidate>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    // ===== FOCUS MODE =====
    const overlay = document.getElementById("focus-overlay");
    const btn = document.getElementById("enterFocusMode");
    const timerDisplay = document.getElementById("focus-timer-display");
    const pauseBtn = document.getElementById("pause-focus");
    const resumeBtn = document.getElementById("resume-focus");
    const exitBtn = document.getElementById("exit-focus");

    let interval = null;
    let remaining = 25 * 60;
    let paused = false;

    function formatTime(s) {
        const m = Math.floor(s / 60).toString().padStart(2,"0");
        const sec = (s % 60).toString().padStart(2,"0");
        return `${m}:${sec}`;
    }

    if (btn) {
        btn.addEventListener("click", () => {
            if (!overlay || !timerDisplay) return;
            overlay.style.display = "block";
            remaining = 25 * 60;
            timerDisplay.textContent = formatTime(remaining);
            interval = setInterval(() => {
                if (!paused) {
                    remaining--;
                    timerDisplay.textContent = formatTime(remaining);
                    if (remaining <= 0) {
                        clearInterval(interval);
                        timerDisplay.textContent = "Time's up!";
                        if (typeof launchConfetti === "function") launchConfetti();
                    }
                }
            }, 1000);
        });
    }

    if (pauseBtn) pauseBtn.addEventListener("click", () => paused = true);
    if (resumeBtn) resumeBtn.addEventListener("click", () => paused = false);
    if (exitBtn) exitBtn.addEventListener("click", () => {
        clearInterval(interval);
        if (overlay) overlay.style.display = "none";
    });

    // ===== TASK TIMER =====
    const startTaskButtons = document.querySelectorAll(".start-task-btn");
    const taskTimerSection = document.getElementById("task-timer-section");
    const selectedTaskName = document.getElementById("selected-task-name");
    const taskTimerDisplay = document.getElementById("timer-display");
    const taskTimerStatus = document.getElementById("timer-status");
    const startTimerBtn = document.getElementById("start-timer");
    const pauseTaskBtn = document.getElementById("pause-timer");
    const resumeTaskBtn = document.getElementById("resume-timer");
    const stopTaskBtn = document.getElementById("stop-timer");

    let taskInterval = null;
    let taskRemaining = 0;
    let taskPaused = false;

    function startTaskTimer(minutes) {
        taskRemaining = minutes * 60;
        taskTimerStatus.textContent = "Running";
        if (taskTimerDisplay) taskTimerDisplay.textContent = formatTime(taskRemaining);

        clearInterval(taskInterval);
        taskInterval = setInterval(() => {
            if (!taskPaused) {
                taskRemaining--;
                if (taskTimerDisplay) taskTimerDisplay.textContent = formatTime(taskRemaining);
                if (taskRemaining <= 0) {
                    clearInterval(taskInterval);
                    taskTimerStatus.textContent = "Completed!";
                    if (taskTimerDisplay) taskTimerDisplay.textContent = "00:00";
                }
            }
        }, 1000);
    }

    startTaskButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const title = btn.dataset.taskTitle;
            if (selectedTaskName) selectedTaskName.textContent = title;
            if (taskTimerSection) {
                taskTimerSection.style.display = "block";
                taskTimerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            const timeInput = document.getElementById("timeInput");
            const minutes = parseInt(timeInput?.value) || 25;
            startTaskTimer(minutes);
        });
    });

    if (pauseTaskBtn) pauseTaskBtn.addEventListener("click", () => { taskPaused = true; if (taskTimerStatus) taskTimerStatus.textContent = "Paused"; });
    if (resumeTaskBtn) resumeTaskBtn.addEventListener("click", () => { taskPaused = false; if (taskTimerStatus) taskTimerStatus.textContent = "Running"; });
    if (stopTaskBtn) stopTaskBtn.addEventListener("click", () => {
        clearInterval(taskInterval);
        if (taskTimerDisplay) taskTimerDisplay.textContent = "00:00";
        if (taskTimerStatus) taskTimerStatus.textContent = "Idle";
    });

    if (startTimerBtn) startTimerBtn.addEventListener("click", () => {
        const timeInput = document.getElementById("timeInput");
        const minutes = parseInt(timeInput?.value) || 25;
        startTaskTimer(minutes);
    });
});
</script>
{% endblock %}
